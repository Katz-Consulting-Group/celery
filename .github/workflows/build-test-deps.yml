on:
  pull_request:
    branches: [master]
    types: [opened, synchronize, closed]
jobs:
  build11:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        repos: ["vine", "billiard", "py-amqp", "kombu", "celery"]
        python-version: ['3.7', '3.8', '3.9', '3.10', 'pypy-3.7', 'pypy-3.8']
        os: ["ubuntu-20.04", "windows-latest"]
        exclude:
            - python-version: 'pypy-3.7'
              os: "windows-latest"
            - python-version: 'pypy-3.8'
              os: "windows-latest"
    steps:
    - name: Install apt packages
      if: startsWith(matrix.os, 'ubuntu-')
      run: |
        sudo apt update && sudo apt-get install -fy libcurl4-openssl-dev libssl-dev gnutls-dev httping expect libmemcached-dev git
    - name: Checkout celery repo
      uses: actions/checkout@v2
    #- name: "Checkout ${{ matrix.repos }}"
    #  uses: actions/checkout@v2
    #  with:
    #    repository: celery/${{ matrix.repos }}
    #    ref: master
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v2.2.2
      with:
        python-version: ${{ matrix.python-version }}
    - name: Get pip cache dir
      id: pip-cache
      run: |
        echo "::set-output name=dir::$(pip cache dir)"
    - name: Cache
      uses: actions/cache@v2.1.6
      with:
        path: ${{ steps.pip-cache.outputs.dir }}
        key:
          ${{ matrix.python-version }}-${{matrix.os}}-${{ hashFiles('**/setup.py') }}
        restore-keys: |
          ${{ matrix.python-version }}-${{matrix.os}}
    - name: Install tox
      run: python -m pip install --upgrade pip tox tox-gh-actions
    - name: Upgrade pip packages with the up-to-date commit in master branch
      run: |
        pip install --upgrade git+https://github.com/celery/${{ matrix.repos }}.git@master
    - name: Install apt packages
      if: ${{ matrix.repos == 'celery' }}
      timeout-minutes: 20
      run: |
        tox --verbose --verbose